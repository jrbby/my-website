<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¦„ 2026 èŒé©¬å¥½è¿å±‹</title>
    <style>
        /* --- 1. åŸºç¡€ç¯å¢ƒ --- */
        * { box-sizing: border-box; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
        
        html, body {
            width: 100%; height: 100%;
            overflow: hidden; 
            touch-action: none;
            overscroll-behavior: none;
        }
        body {
            margin: 0; padding: 0;
            font-family: "Varela Round", "Microsoft YaHei", sans-serif;
            background-color: #fffaf0; 
            background-image: radial-gradient(circle at 50% 30%, #fff3e0 0%, #fffaf0 70%);
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; flex-direction: column; align-items: center; 
            justify-content: flex-start; padding-top: 50px;
            color: #5d4037; -webkit-tap-highlight-color: transparent;
        }

        /* --- 2. é™æ€è£…é¥° --- */
        .deco-item {
            position: absolute; 
            z-index: 20; 
            display: flex; flex-direction: column; align-items: center;
            cursor: pointer; pointer-events: auto;
            width: 60px; height: 60px;
            justify-content: center; 
        }
        .deco-icon {
            font-size: 32px;
            filter: drop-shadow(2px 2px 0px rgba(255, 171, 145, 0.3));
            animation: floatBreathe 4s ease-in-out infinite;
            transition: transform 0.2s;
            line-height: 1;
        }
        .deco-item:active .deco-icon { transform: scale(1.3); }

        @keyframes floatBreathe {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-6px) scale(1.1); }
        }

        /* ä½ç½®å®šä¹‰ */
        .pos-1 { top: 60px; left: 15px; }    /* å·¦ä¸Šäº‘ */
        .pos-2 { top: 40%; left: 5px; }      /* å·¦ä¸­äº‘ */
        .pos-3 { bottom: 15%; left: 20px; }  /* å·¦ä¸‹èŠ± */
        .pos-4 { top: 70px; right: 15px; }   /* å³ä¸Šæ˜Ÿ */
        .pos-5 { top: 45%; right: 5px; }     /* å³ä¸­æ˜Ÿ */
        .pos-6 { bottom: 15%; right: 20px; } /* å³ä¸‹ç³– */

        .pos-1 .deco-icon { font-size: 36px; }
        .pos-2 .deco-icon { font-size: 32px; animation-delay: 1s; }
        .pos-3 .deco-icon { font-size: 40px; animation-delay: 2s; }
        .pos-4 .deco-icon { font-size: 28px; animation-delay: 0.5s; }
        .pos-5 .deco-icon { font-size: 30px; animation-delay: 1.5s; }
        .pos-6 .deco-icon { font-size: 35px; animation-delay: 2.5s; }

        /* --- æ°”æ³¡æ ·å¼ --- */
        .bubble {
            position: absolute;
            background: #fff; 
            border: 1px solid #ffccbc;
            color: #5d4037; font-size: 12px;
            padding: 5px 8px; border-radius: 6px;
            white-space: nowrap; pointer-events: none;
            opacity: 0; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: max-content;
            transform-origin: center;
            transition: opacity 0.3s; 
            z-index: 25;
        }

        .bubble.show { 
            opacity: 1; 
            animation: elasticPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes elasticPop {
            0% { opacity: 0; transform: scale(0.5); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* æ°”æ³¡å°å°¾å·´ */
        .bubble::after, .bubble::before {
            content: ''; position: absolute; width: 0; height: 0; border-style: solid;
        }
        .bubble::after { z-index: 1; }
        .bubble::before { z-index: 0; }

        /* --- æ°”æ³¡æ–¹ä½ --- */
        .b-top-right { bottom: 80%; left: 80%; margin-bottom: 5px; margin-left: 5px; }
        .b-top-right::after { bottom: -6px; left: 10px; border-width: 6px 6px 0 0; border-color: #fff transparent transparent transparent; }
        .b-top-right::before { bottom: -7px; left: 9px; border-width: 7px 7px 0 0; border-color: #ffccbc transparent transparent transparent; }

        .b-top-left { bottom: 80%; right: 80%; margin-bottom: 5px; margin-right: 5px; }
        .b-top-left::after { bottom: -6px; right: 10px; border-width: 6px 0 0 6px; border-color: #fff transparent transparent transparent; }
        .b-top-left::before { bottom: -7px; right: 9px; border-width: 7px 0 0 7px; border-color: #ffccbc transparent transparent transparent; }

        .b-bottom-constrained { top: 100%; margin-top: 5px; white-space: normal; max-width: 90px; text-align: center; }
        .b-left-c { left: 0; }
        .b-left-c::after { top: -6px; left: 15px; border-width: 0 6px 6px; border-color: transparent transparent #fff; }
        .b-left-c::before { top: -7px; left: 14px; border-width: 0 7px 7px; border-color: transparent transparent #ffccbc; }
        .b-right-c { right: 0; }
        .b-right-c::after { top: -6px; right: 15px; border-width: 0 6px 6px; border-color: transparent transparent #fff; }
        .b-right-c::before { top: -7px; right: 14px; border-width: 0 7px 7px; border-color: transparent transparent #ffccbc; }

        /* --- 3. åˆ†å±‚æ‰è½ç³»ç»Ÿ (ä¿®å¤æ ¸å¿ƒ) --- */
        /* é€šç”¨æ ·å¼ */
        .falling-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; overflow: hidden;
        }
        
        /* èƒŒæ™¯å±‚ï¼šåœ¨å¼¹çª—ä¹‹ä¸‹ (Modalæ˜¯1500) */
        #layer-bg { z-index: 50; }
        
        /* å‰æ™¯å±‚ï¼šåœ¨å¼¹çª—ä¹‹ä¸Š */
        #layer-fg { z-index: 2000; }
        
        .falling-obj {
            position: absolute;
            pointer-events: auto; cursor: grab;
            will-change: transform;
            padding: 10px; margin: -10px; 
        }
        .falling-obj:active { cursor: grabbing; }
        
        .red-packet-style {
            width: 22px; height: 39px; 
            background: linear-gradient(135deg, #d32f2f, #b71c1c);
            border-radius: 3px;
            border: 1px solid #e57373;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            display: flex; justify-content: center; align-items: center;
            color: #ffd700; font-size: 13px; font-weight: bold;
            font-family: serif;
        }
        .red-packet-style::after { content: "ç¦"; }

        .particle { position: absolute; pointer-events: none; will-change: transform; }

        /* --- 5. åº•éƒ¨çˆ±å¿ƒ --- */
        .d-heart {
            position: absolute; bottom: 12%; left: 50%; 
            transform: translateX(-50%);
            width: 50px; height: 50px; 
            font-size: 40px; 
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; pointer-events: auto; z-index: 20;
            animation: pulseHeart 2s infinite;
            filter: drop-shadow(0 4px 4px rgba(0,0,0,0.1));
        }
        .d-heart:active { transform: translateX(-50%) scale(0.8); }
        @keyframes pulseHeart { 
            0% { transform: translateX(-50%) scale(1); } 
            50% { transform: translateX(-50%) scale(1.15); } 
            100% { transform: translateX(-50%) scale(1); } 
        }

        /* --- 6. æ ‡é¢˜ --- */
        header {
            text-align: center; z-index: 10; cursor: pointer;
            opacity: 0; transition: opacity 1s; margin-bottom: 5px; position: relative;
        }
        .title-box {
            background: #ff7043; color: #fff; padding: 8px 25px;
            border-radius: 50px; font-size: 22px; font-weight: 800;
            box-shadow: 0 5px 0 #d84315; display: inline-block;
            animation: pulse 2s infinite;
        }
        .title-box:active { transform: scale(0.95); box-shadow: 0 2px 0 #d84315; }
        .subtitle {
            margin-top: 15px; font-size: 13px; color: #8d6e63;
            background: rgba(255,255,255,0.3); border: 1px solid rgba(255,255,255,0.5);
            padding: 4px 12px; border-radius: 12px;
        }

        /* --- 7. ä¹å®«æ ¼ --- */
        .grid-container {
            display: grid; grid-template-columns: repeat(3, 1fr); 
            gap: 12px; padding: 25px; width: 100%; max-width: 360px; margin-top: 10px;
            z-index: 10; opacity: 0; transition: opacity 1s;
        }

        /* --- 8. å¡ç‰‡ç³»ç»Ÿ --- */
        .card-scene { aspect-ratio: 1 / 1.15; perspective: 800px; cursor: pointer; }
        .card {
            width: 100%; height: 100%; position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.4, 0.2, 0.2, 1);
            border-radius: 18px; transform-origin: center center;
        }
        .card.breathing { animation: breathe 3s infinite ease-in-out; }
        
        .card-scene:nth-child(3n+1) .card.breathing { animation-delay: 0s; }
        .card-scene:nth-child(3n+2) .card.breathing { animation-delay: 1s; }
        .card-scene:nth-child(3n+3) .card.breathing { animation-delay: 2s; }
        
        .card.is-flipped { transform: rotateY(180deg); }
        .card-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; border-radius: 18px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 3px solid #fff; box-shadow: 0 4px 8px rgba(255, 171, 145, 0.3);
            background: #fff; left: 0; top: 0; box-sizing: border-box;
        }
        .card-front { background: #ffab91; }
        
        .card-front::before, .card-front::after {
            content: ""; position: absolute; top: -10px; width: 14px; height: 22px;
            background: #ffab91; border-radius: 10px; border: 3px solid #fff; z-index: -1;
            transform-origin: bottom center;
        }
        .card-front::before { left: 18px; transform: rotate(-20deg); animation: earTwitchLeft 5s infinite; }
        .card-front::after { right: 18px; transform: rotate(20deg); animation: earTwitchRight 5s infinite; }
        
        @keyframes earTwitchLeft {
            0%, 90% { transform: rotate(-20deg); }
            92% { transform: rotate(-28deg); }
            94% { transform: rotate(-20deg); }
            96% { transform: rotate(-26deg); }
            100% { transform: rotate(-20deg); }
        }
        @keyframes earTwitchRight {
            0%, 91% { transform: rotate(20deg); }
            93% { transform: rotate(28deg); }
            95% { transform: rotate(20deg); }
            97% { transform: rotate(26deg); }
            100% { transform: rotate(20deg); }
        }

        /* è¡¨æƒ… */
        .face { position: relative; width: 60px; height: 40px; margin-bottom: 5px; }
        .eye { position: absolute; top: 13px; width: 7px; height: 7px; background: #5d4037; border-radius: 50%; animation: blink 4s infinite; }
        .eye.left { left: 10px; } .eye.right { right: 10px; }
        .eye.happy { width: 7px; height: 7px; background: transparent; border: 2px solid transparent; border-top-color: #5d4037; border-right-color: #5d4037; border-radius: 0; animation: none; top: 14px; transform: rotate(-45deg); }
        .eye.happy.left { left: 10px; } .eye.happy.right { right: 10px; }
        .eye.arch { width: 8px; height: 4px; background: transparent; border: 2px solid transparent; border-top-color: #5d4037; border-radius: 50% 50% 0 0; animation: none; top: 14px; }
        .eye.arch.left { left: 9px; } .eye.arch.right { right: 9px; }

        .mouth {
            position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%);
            width: 8px; height: 4px;
            border: 2px solid transparent; border-bottom-color: #5d4037;
            border-radius: 50%;
        }
        .mouth.o { width: 5px; height: 5px; border: 2px solid #5d4037; background: #5d4037; border-radius: 50%; }
        .mouth.big { width: 10px; height: 5px; border: 2px solid transparent; border-bottom-color: #5d4037; }
        
        .blush { position: absolute; top: 25px; width: 12px; height: 5px; background: #ffccbc; opacity: 0.6; border-radius: 50%; }
        .blush.left { left: 0; } .blush.right { right: 0; }
        
        .prompt-badge { background: #fff; color: #ff7043; font-size: 12px; font-weight: bold; padding: 2px 8px; border-radius: 8px; box-shadow: 0 2px 0 rgba(0,0,0,0.05); }

        .card-back { background: #fff; transform: rotateY(180deg); border-color: #ffccbc; }
        .prize-val { font-size: 24px; font-weight: 900; color: #ff5722; margin-bottom: 4px; }
        .prize-tag { font-size: 10px; color: #a1887f; }

        /* --- 9. å¼¹çª— (Z-Index: 1500) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 248, 240, 0.7); display: none;
            justify-content: center; align-items: center; z-index: 1500;
            backdrop-filter: blur(5px);
        }
        .modal {
            background: #fff; width: 75%; padding: 30px 20px;
            border-radius: 30px; text-align: center;
            box-shadow: 0 10px 30px rgba(255, 112, 67, 0.15);
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 4px solid #fff3e0;
        }
        .modal-icon { font-size: 48px; margin-bottom: 10px; display: inline-block; }
        .modal-title { color: #8d6e63; font-size: 16px; margin-bottom: 5px; }
        .modal-val { color: #ff5722; font-size: 38px; font-weight: 900; margin: 5px 0 15px; }
        .modal-desc { color: #a1887f; font-size: 13px; line-height: 1.5; margin-bottom: 25px; }
        .close-btn {
            background: linear-gradient(to right, #ffab91, #ff7043);
            color: #fff; border: none; padding: 10px 40px;
            border-radius: 50px; font-size: 16px; font-weight: bold; cursor: pointer;
            box-shadow: 0 5px 10px rgba(255, 112, 67, 0.2);
        }

        /* --- å¼€é—¨å°é¢ --- */
        #welcome-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 250, 240, 0.95); z-index: 5000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(5px); transition: opacity 0.5s;
        }
        .welcome-btn {
            background: #ff7043; color: #fff; padding: 15px 50px;
            border-radius: 50px; font-size: 20px; font-weight: bold; border: none;
            box-shadow: 0 8px 20px rgba(255, 87, 34, 0.4); animation: pulse 1.5s infinite;
        }

        /* éŸ³ä¹å›¾æ ‡ */
        .music-tip {
            position: fixed; top: 15px; right: 15px;
            font-size: 24px; z-index: 200;
            animation: rotateMusic 4s linear infinite;
            cursor: pointer; transition: opacity 0.3s;
        }
        .music-tip.paused { animation-play-state: paused; opacity: 0.4; }

        @keyframes pulse { 0%,100%{transform:scale(1);} 50%{transform:scale(1.05);} }
        @keyframes popIn { from{transform:scale(0.5);opacity:0} to{transform:scale(1);opacity:1} }
        @keyframes rotateMusic { from {transform: rotate(0deg);} to {transform: rotate(360deg);} }
    </style>
</head>
<body>

    <audio id="bgm" src="https://music.163.com/song/media/outer/url?id=2644291299.mp3" loop preload="auto"></audio>
    <div class="music-tip" onclick="toggleMusic(event)">ğŸµ</div>

    <!-- ä¿®å¤ï¼šåˆ†ç¦»ä¸¤ä¸ªå±‚çº§å®¹å™¨ -->
    <div id="layer-bg" class="falling-container"></div>
    <div id="layer-fg" class="falling-container"></div>

    <!-- é™æ€è£…é¥° -->
    <div class="deco-item pos-1" onclick="triggerBubble(this)">
        <div class="deco-icon">â˜ï¸</div>
        <div class="bubble b-top-right">æ–°å¹´å¿«ä¹!</div>
    </div>
    <div class="deco-item pos-2" onclick="triggerBubble(this)">
        <div class="deco-icon">â˜ï¸</div>
        <div class="bubble b-bottom-constrained b-left-c">è´¢æºæ»šæ»š!</div>
    </div>
    <div class="deco-item pos-3" onclick="triggerBubble(this)">
        <div class="deco-icon">ğŸŒ¸</div>
        <div class="bubble b-top-right">å¹³å®‰å–œä¹!</div>
    </div>
    <div class="deco-item pos-4" onclick="triggerBubble(this)">
        <div class="deco-icon">âœ¨</div>
        <div class="bubble b-top-left">å¥½è¿è¿è¿!</div>
    </div>
    <div class="deco-item pos-5" onclick="triggerBubble(this)">
        <div class="deco-icon">âœ¨</div>
        <div class="bubble b-bottom-constrained b-right-c">å¿ƒæƒ³äº‹æˆ!</div>
    </div>
    <div class="deco-item pos-6" onclick="triggerBubble(this)">
        <div class="deco-icon">ğŸ¬</div>
        <div class="bubble b-top-left">å¤§å‰å¤§åˆ©!</div>
    </div>
    
    <!-- åº•éƒ¨çˆ±å¿ƒ -->
    <div class="d-heart" onclick="triggerEasterEgg()">ğŸ’•</div>

    <!-- å¼€é—¨å°é¢ -->
    <div id="welcome-screen" onclick="startGame()">
        <div style="font-size: 60px; margin-bottom: 20px;">ğŸ¦„</div>
        <button class="welcome-btn">å¼€å¯2026å¥½è¿</button>
        <p style="margin-top:20px; color:#a1887f; font-size:12px;">ç‚¹å‡»ä»»æ„å¤„è¿›å…¥</p>
    </div>

    <header onclick="adminCheck()">
        <div class="title-box">ğŸ¦„ 2026 èŒé©¬å¥½è¿</div>
        <br>
        <div class="subtitle">å‰©ä½™æœºä¼š <span id="chance" style="color:#ff5722;font-weight:bold;">3</span> æ¬¡</div>
    </header>

    <div class="grid-container" id="grid"></div>

    <div class="modal-overlay" id="modal">
        <div class="modal">
            <div class="modal-icon" id="m-icon">ğŸ</div>
            <div class="modal-title" id="m-title"></div>
            <div class="modal-val" id="m-val"></div>
            <div class="modal-desc" id="m-desc"></div>
            <button class="close-btn" onclick="closeModal()">å¼€å¿ƒæ”¶ä¸‹</button>
        </div>
    </div>

    <script>
        const rawPrizes = [
            { t:'m', v:'188', i:'ğŸ¦„', d:'å“‡ï¼æ¬§æ°”çˆ†æ£šï¼<br>2026 é©¬ä¸Šæš´å¯Œï¼' },
            { t:'m', v:'99',  i:'ğŸ’–', d:'é•¿é•¿ä¹…ä¹…<br>å¹¸ç¦ç¾æ»¡ä¸€æ•´å¹´ï¼' },
            { t:'m', v:'88',  i:'ğŸ’°', d:'æ­å–œå‘è´¢<br>å¤§å‰å¤§åˆ© ä¸‡äº‹é¡ºï¼' },
            { t:'m', v:'66',  i:'âœ¨', d:'å…­å…­å¤§é¡º<br>å¥½è¿ä¸€ç›´é™ªç€ä½ ï¼' },
            { t:'m', v:'50',  i:'ğŸ—', d:'å°æ‰‹ä¸€æ°”<br>åˆé¥­åŠ ä¸ªå¤§é¸¡è…¿ï¼' },
            { t:'w', v:'é©¬åˆ°<br>æˆåŠŸ', i:'ğŸŒˆ', d:'å¿ƒæƒ³äº‹æˆ<br>æ‰€æœ‰æ„¿æœ›éƒ½çµéªŒï¼' },
            { t:'w', v:'å…ƒæ°”<br>æ»¡æ»¡', i:'ğŸ’ª', d:'èº«ä½“å¥åº·<br>æ¯å¤©éƒ½æ´»åŠ›å››å°„ï¼' },
            { t:'w', v:'æ»¡è¶³<br>æ„¿æœ›', i:'ğŸŒŸ', d:'æ­å–œï¼ä½ å¯ä»¥æå‡ºä¸€ä¸ªæ„¿æœ›<br>è®©ç®¡ç†å‘˜å¸®ä½ å®ç°ï¼' },
            { t:'x', v:'è°¢è°¢<br>å‚ä¸', i:'ğŸ€', d:'å“å‘€å·®ä¸€ç‚¹ç‚¹<br>æ˜å¹´è¿æ°”ä¸€å®šçˆ†æ£šï¼' }
        ];

        const promptWords = ['ç‚¹æˆ‘', 'å¥½è¿', 'å¼€å¯', 'æš´å¯Œ', 'å¿…ä¸­', 'å¼€å¿ƒ'];
        const STORAGE_KEY = 'lucky_2026_data_v13'; 
        const bubbleTexts = ["æ–°å¹´å¿«ä¹!", "å¥½è¿è¿è¿!", "æˆ³æˆ‘å¹²å˜›?", "è´¢æºæ»šæ»š!", "å¿ƒæƒ³äº‹æˆ!", "å¹³å®‰å–œä¹!", "å¤§å‰å¤§åˆ©!", "å…ƒæ°”æ»¡æ»¡!"];

        let gameState = { chances: 3, deck: [] };
        let canClick = true;

        // éŸ³ä¹æ§åˆ¶
        function toggleMusic(e) {
            e.stopPropagation();
            const bgm = document.getElementById('bgm');
            const tip = document.querySelector('.music-tip');
            if (bgm.paused) { bgm.play(); tip.classList.remove('paused'); } 
            else { bgm.pause(); tip.classList.add('paused'); }
        }

        // æ°”æ³¡äº’åŠ¨
        function triggerBubble(el) {
            const bubble = el.querySelector('.bubble');
            bubble.innerText = bubbleTexts[Math.floor(Math.random() * bubbleTexts.length)];
            bubble.classList.remove('show');
            void bubble.offsetWidth; 
            bubble.classList.add('show');
            setTimeout(() => { bubble.classList.remove('show'); }, 3000);
        }

        // è‡ªåŠ¨æ°”æ³¡
        setInterval(() => {
            const items = document.querySelectorAll('.deco-item');
            const target = items[Math.floor(Math.random() * items.length)];
            triggerBubble(target);
        }, 4000);

        // --- ç‰©ç†å¼•æ“ (Shared Loop) ---
        const particles = [];
        const bgLayer = document.getElementById('layer-bg');
        const fgLayer = document.getElementById('layer-fg');

        function spawnFallingItem() {
            const items = ['ğŸ®', 'ğŸ§§', 'â„ï¸', 'âœ¨'];
            const char = items[Math.floor(Math.random() * items.length)];
            const el = document.createElement('div');
            el.className = 'falling-obj';
            
            if (char === 'ğŸ§§') {
                el.classList.add('red-packet-style');
            } else {
                el.innerText = char;
                el.style.fontSize = (Math.random() * 20 + 15) + 'px';
                el.style.opacity = 0.6;
            }
            
            const startX = Math.random() * (window.innerWidth - 50);
            
            const p = {
                el: el,
                x: startX,
                y: -60,
                vx: 0, 
                vy: Math.random() * 0.6 + 0.6, 
                rot: 0,
                rotSpeed: (Math.random() - 0.5) * 1.5,
                type: 'obj',
                drag: false
            };
            
            bindDrag(p);
            // ä¿®å¤ï¼šèƒŒæ™¯æ‰è½ç‰©æ·»åŠ åˆ° bgLayer (z-index 50)
            bgLayer.appendChild(el);
            particles.push(p);
        }

        function bindDrag(p) {
            let startX, startY;
            p.el.addEventListener('touchstart', (e) => {
                e.preventDefault();
                p.drag = true;
                const t = e.touches[0];
                startX = t.clientX - p.x;
                startY = t.clientY - p.y;
            });
            p.el.addEventListener('touchmove', (e) => {
                if(!p.drag) return;
                const t = e.touches[0];
                p.x = t.clientX - startX;
                p.y = t.clientY - startY;
            });
            p.el.addEventListener('touchend', () => { p.drag = false; });
        }

        function fireRain(emoji = null, count = 50) {
            const colors = ['#FFD700', '#FF4081', '#00E5FF', '#76FF03', '#AA00FF', '#FF5252'];
            
            for(let i=0; i<count; i++) {
                setTimeout(() => {
                    const el = document.createElement('div');
                    el.className = 'particle';
                    
                    const p = {
                        el: el,
                        x: Math.random() * window.innerWidth,
                        y: -30,
                        type: emoji ? 'heart' : 'ribbon',
                        rotX: Math.random() * 360,
                        rotY: Math.random() * 360,
                        rotZ: Math.random() * 360
                    };

                    if (emoji) {
                        el.innerText = emoji;
                        el.style.fontSize = (Math.random() * 10 + 20) + 'px';
                        p.vy = Math.random() * 1.2 + 1.5; 
                        p.vx = 0; 
                        p.swaySpeed = Math.random() * 0.05 + 0.02;
                        p.swayOffset = Math.random() * 100; 
                    } else {
                        el.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
                        el.style.width = (Math.random() * 6 + 5) + 'px';
                        el.style.height = (Math.random() * 10 + 8) + 'px';
                        p.vy = Math.random() * 2 + 1.5; 
                        p.vx = (Math.random() - 0.5) * 1; 
                        p.rotSpeedX = (Math.random() - 0.5) * 10;
                        p.rotSpeedY = (Math.random() - 0.5) * 10;
                    }

                    // ä¿®å¤ï¼šåº†ç¥é›¨æ·»åŠ åˆ° fgLayer (z-index 2000)
                    fgLayer.appendChild(el);
                    particles.push(p);

                }, i * (emoji ? 50 : 20)); 
            }
        }

        function gameLoop() {
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                if (p.drag) {
                    p.el.style.transform = `translate(${p.x}px, ${p.y}px) rotate(${p.rot}deg)`;
                    continue;
                }
                if (p.type === 'obj') {
                    p.y += p.vy;
                    p.rot += p.rotSpeed;
                    p.el.style.transform = `translate(${p.x}px, ${p.y}px) rotate(${p.rot}deg)`;
                } 
                else if (p.type === 'heart') {
                    p.y += p.vy;
                    const sway = Math.sin(p.y * 0.01 + p.swayOffset) * 1.5; 
                    p.x += sway;
                    p.el.style.transform = `translate(${p.x}px, ${p.y}px)`;
                } 
                else {
                    p.y += p.vy;
                    p.x += p.vx;
                    p.rotX += p.rotSpeedX;
                    p.rotY += p.rotSpeedY;
                    p.el.style.transform = `translate3d(${p.x}px, ${p.y}px, 0) rotateX(${p.rotX}deg) rotateY(${p.rotY}deg)`;
                }
                if (p.y > window.innerHeight + 50) {
                    p.el.remove();
                    particles.splice(i, 1);
                }
            }
            requestAnimationFrame(gameLoop);
        }

        setInterval(spawnFallingItem, 4000); 
        requestAnimationFrame(gameLoop);

        // --- ä¸šåŠ¡é€»è¾‘ ---
        function triggerEasterEgg() {
            const m = document.getElementById('modal');
            document.getElementById('m-icon').innerText = 'ğŸ’•';
            document.getElementById('m-title').innerText = 'å‘ç°éšè—å½©è›‹';
            document.getElementById('m-val').innerHTML = 'çˆ±ä½ å“Ÿ';
            document.getElementById('m-val').style.color = '#e91e63';
            document.getElementById('m-desc').innerHTML = 'æ–°çš„ä¸€å¹´ï¼Œæ„Ÿè°¢æœ‰ä½ é™ªä¼´ï¼<br>è¿™æ˜¯ç»™ä½ çš„ä¸“å±å°å¿ƒå¿ƒ~';
            m.style.display = 'flex';
            fireRain('ğŸ©·', 50); 
        }

        function startGame() {
            const screen = document.getElementById('welcome-screen');
            const bgm = document.getElementById('bgm');
            bgm.play().then(() => {
                document.querySelector('.music-tip').classList.remove('paused');
            }).catch(e => console.log(e));
            
            screen.style.opacity = '0';
            setTimeout(() => {
                screen.style.display = 'none';
                document.querySelector('header').style.opacity = '1';
                document.querySelector('.grid-container').style.opacity = '1';
            }, 500);
        }

        function init() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                gameState = JSON.parse(savedData);
            } else {
                createNewGame();
            }
            render();
            updateUI();
        }

        function createNewGame() {
            gameState.chances = 3;
            gameState.deck = [];
            let tempPrizes = [...rawPrizes];
            for (let i = tempPrizes.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [tempPrizes[i], tempPrizes[j]] = [tempPrizes[j], tempPrizes[i]];
            }

            for(let i=0; i<9; i++) {
                const rEye = Math.random();
                let eye = 'eye';
                if(rEye > 0.66) eye = 'eye happy';
                else if(rEye > 0.33) eye = 'eye arch';
                const rMouth = Math.random();
                let mouth = 'mouth';
                if(rMouth > 0.66) mouth = 'mouth o';
                else if(rMouth > 0.33) mouth = 'mouth big';

                gameState.deck.push({
                    prize: tempPrizes[i],
                    isFlipped: false,
                    word: promptWords[i % promptWords.length],
                    face: { eye: eye, mouth: mouth }
                });
            }
            saveState();
        }

        function saveState() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(gameState));
        }

        function updateUI() {
            document.getElementById('chance').innerText = gameState.chances;
        }

        function render() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            gameState.deck.forEach((item, index) => {
                const scene = document.createElement('div');
                scene.className = 'card-scene';
                const flippedClass = item.isFlipped ? 'is-flipped' : 'breathing';
                
                scene.innerHTML = `
                    <div class="card ${flippedClass}" onclick="handleClick(${index}, this)">
                        <div class="card-face card-front">
                            <div class="face">
                                <div class="${item.face.eye} left"></div>
                                <div class="${item.face.eye} right"></div>
                                <div class="blush left"></div>
                                <div class="blush right"></div>
                                <div class="${item.face.mouth}"></div>
                            </div>
                            <div class="prompt-badge">${item.word}</div>
                        </div>
                        <div class="card-face card-back">
                            <div class="prize-val" style="${item.prize.t==='x'?'color:#ccc;font-size:22px':''}">${item.prize.t==='m'?'Â¥':''}${item.prize.v}</div>
                            <div class="prize-tag">${item.prize.t==='x'?'å†æ¥å†å‰':'æ­å–œæ­å–œ'}</div>
                        </div>
                    </div>
                `;
                grid.appendChild(scene);
            });
        }

        function handleClick(index, card) {
            const item = gameState.deck[index];
            if (item.isFlipped) {
                showResult(item.prize);
                return;
            }
            if (!canClick || gameState.chances <= 0) {
                if(gameState.chances <= 0) {
                    alert("ä¸æ»¡æ„æƒ³é‡æŠ½ï¼Ÿæ³æ±‚ç®¡ç†å‘˜ç»™ä¸ªæœºä¼šå§~");
                }
                return;
            }
            canClick = false;
            gameState.chances--;
            item.isFlipped = true;
            saveState();
            updateUI();
            card.classList.remove('breathing');
            void card.offsetWidth;
            card.classList.add('is-flipped');
            setTimeout(() => {
                showResult(item.prize);
                canClick = true;
            }, 700);
        }

        let adminCount = 0;
        let adminTimer = null;
        function adminCheck() {
            adminCount++;
            clearTimeout(adminTimer);
            adminTimer = setTimeout(() => { adminCount = 0; }, 800);
            if (adminCount >= 5) {
                createNewGame(); 
                render();
                updateUI();
                alert("ğŸ”’ ç®¡ç†å‘˜ç‰¹æƒï¼šæ–°çš„ä¸€å±€å·²å¼€å§‹ï¼");
                adminCount = 0;
            }
        }

        function showResult(item) {
            const m = document.getElementById('modal');
            const mt = document.getElementById('m-title');
            const mv = document.getElementById('m-val');
            const md = document.getElementById('m-desc');
            const mi = document.getElementById('m-icon');
            mi.innerText = item.i;
            mv.innerHTML = (item.t==='m'?'Â¥':'') + item.v;
            md.innerHTML = item.d;
            if (item.t === 'x') {
                mt.innerText = "é—æ†¾é”™è¿‡";
                mv.style.color = "#ccc";
                mv.style.fontSize = "28px";
            } else {
                mt.innerText = "ğŸ‰ æ­å–œè·å¾—";
                mv.style.color = "#ff7043";
                mv.style.fontSize = "40px";
                fireRain(); 
            }
            m.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        let musicStarted = false;
        document.addEventListener('click', () => {
            if (!musicStarted) {
                const bgm = document.getElementById('bgm');
                bgm.play().then(() => {
                    musicStarted = true;
                    document.querySelector('.music-tip').classList.remove('paused');
                }).catch(e => {});
            }
        });
        document.addEventListener('gesturestart', function(e) { e.preventDefault(); });
        document.addEventListener('dblclick', function(e) { e.preventDefault(); });
        init();
    </script>
</body>
</html>
